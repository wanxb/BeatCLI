# 🎵 BeatCLI - Console Music Player

一个基于 Rust 开发的跨平台控制台音乐播放器，提供丰富的音乐播放功能和优雅的终端界面体验。

## ✨ 特性

### 🎶 音频支持
- 支持多种音频格式：MP3, FLAC, WAV, OGG 等
- 高质量音频播放，基于 rodio 音频库
- 自动音频文件扫描和播放列表管理

### 🎮 播放控制
- 完整的播放控制：播放、暂停、继续、上一首、下一首
- 多种播放模式：顺序播放、单曲循环、随机播放
- 音量控制（0-100%）
- 播放进度跟踪

### 📝 歌词功能
- LRC 歌词文件自动加载和解析
- 实时歌词同步显示
- **流式歌词输出**：无闪烁的平滑歌词滚动
- 歌词显示模式切换（流式输出/清屏刷新）
- 可切换歌词显示开关

### 🎨 用户界面
- 统一的控制台界面设计
- 实时播放状态显示
- 中文字符完美支持
- 事件驱动的响应式界面更新
- 智能 Flash 消息系统

### ⚡ 性能优化
- 事件驱动架构：三线程设计（音频线程、UI线程、输入线程）
- 高性能并发：使用 crossbeam-channel 和 parking_lot
- 智能 UI 刷新：只在必要时更新界面
- 内存安全：Rust 语言保证

## 🚀 快速开始

### 环境要求

- Rust 2024 edition
- 支持的操作系统：Windows, macOS, Linux

### 编译安装

```bash
# 克隆项目
git clone <repository-url>
cd BeatCLI

# 编译发布版本
cargo build --release

# 运行程序
cargo run --release
# 或直接运行编译后的可执行文件
./target/release/BeatCLI
```

## 📖 使用指南

### 基本操作流程

1. **启动程序**
   ```bash
   cargo run --release
   ```

2. **选择音乐目录**
   ```
   /folder /path/to/your/music
   ```

3. **开始播放**
   ```
   /play        # 播放第一首
   /play 3      # 播放第3首
   ```

4. **控制播放**
   ```
   /pause       # 暂停
   /resume      # 继续
   /next        # 下一首
   /prev        # 上一首
   ```

### 完整命令列表

| 命令 | 说明 | 示例 |
|------|------|------|
| `/help` | 显示帮助信息 | `/help` |
| `/folder <path>` | 选择音乐文件夹 | `/folder D:\Music` |
| `/list` | 列出播放列表 | `/list` |
| `/play [N]` | 播放第N首歌曲 | `/play 1` |
| `/pause` | 暂停播放 | `/pause` |
| `/resume` | 继续播放 | `/resume` |
| `/next` | 下一首 | `/next` |
| `/prev` | 上一首 | `/prev` |
| `/volume <0-100>` | 设置音量 | `/volume 80` |
| `/mode <mode>` | 切换播放模式 | `/mode shuffle` |
| `/lyrics` | 切换歌词显示 | `/lyrics` |
| `/lmode` | 切换歌词显示模式 | `/lmode` |
| `/now` | 显示当前播放信息 | `/now` |
| `/quit` | 退出程序 | `/quit` |

### 播放模式

- `sequential` (seq) - 顺序播放
- `repeatone` (one) - 单曲循环  
- `shuffle` (shu) - 随机播放

### 歌词功能

1. **自动歌词加载**：程序会自动寻找与音频文件同名的 .lrc 文件
2. **实时同步**：歌词会根据播放进度实时高亮当前行
3. **流式输出**：默认使用流式输出，避免界面闪烁
4. **模式切换**：使用 `/lmode` 在流式输出和清屏模式间切换

## 🎵 界面展示

### 播放界面示例

```
████████████████████████████████████████████████████████████
█                  🎵 播放状态                           █
████████████████████████████████████████████████████████████

  当前播放: 夜曲.flac
  下一首:   夜的第七章.flac

  播放模式: 顺序播放    音量: 80%    播放列表: 3 首
════════════════════════════════════════════════════════════

══════════════════════ 🎶 歌词 ═══════════════════════
    天空灰得像哭过
    离开你以后并没有更自由
  ▶ 冷清的街道思念着谁
    可惜我们回不去
    留下我一个人憔悴
════════════════════════════════════════════════════════════
```

## 🏗️ 项目架构

### 核心模块

- **main.rs** - 程序入口点和事件驱动架构
- **player.rs** - 音频播放引擎（基于 rodio）
- **playlist.rs** - 播放列表管理
- **ui.rs** - 用户界面渲染和流式输出
- **lyrics.rs** - LRC 歌词解析和同步
- **command.rs** - 命令解析和验证

### 技术栈

- **语言**: Rust 2024 Edition
- **音频**: rodio 0.17 - 跨平台音频播放
- **终端**: crossterm 0.27 - 跨平台终端控制
- **并发**: crossbeam-channel 0.5 - 高性能消息传递
- **锁机制**: parking_lot 0.12 - 高性能互斥锁
- **文件遍历**: walkdir 2.0 - 目录扫描
- **错误处理**: anyhow 1.0 - 错误传播
- **Unicode**: unicode-width 0.1 - 字符宽度计算

### 架构设计

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Input Thread  │    │  Audio Thread   │    │   UI Thread     │
│                 │    │                 │    │                 │
│ • 用户输入处理   │◄──►│ • 音频播放控制   │◄──►│ • 界面渲染       │
│ • 命令解析       │    │ • 歌词时间同步   │    │ • 流式输出       │
│ • 事件分发       │    │ • 播放状态管理   │    │ • Flash消息     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
          │                       │                       │
          └───────────────────────┼───────────────────────┘
                                  │
                        ┌─────────▼─────────┐
                        │   Event System    │
                        │                   │
                        │ • AppEvent枚举    │
                        │ • 事件驱动更新     │
                        │ • 线程间通信       │
                        └───────────────────┘
```

## 🔧 开发指南

### 编译要求

```toml
[dependencies]
anyhow = "1"
walkdir = "2"
rand = "0.8"
parking_lot = "0.12"
crossbeam-channel = "0.5"
crossterm = "0.27"
rodio = "0.17"
unicode-width = "0.1"
```

### 开发模式运行

```bash
# 开发模式编译和运行
cargo run

# 发布模式编译（推荐）
cargo build --release
```

### 代码规范

遵循 CLI 命令异常处理规范：
1. 播放列表状态检查
2. 参数有效性验证  
3. 文件存在性检查
4. 播放状态验证
5. 边界条件处理
6. 完整的错误提示

## 🎯 技术亮点

### 1. 事件驱动架构
- 三线程设计确保高响应性
- 事件系统避免线程竞争
- 智能UI更新减少资源消耗

### 2. 流式歌词输出
- 使用ANSI转义序列精确控制
- 智能范围检测减少不必要更新
- 批量缓冲输出避免闪烁
- 分离高亮更新和文本滚动

### 3. 高性能并发
- parking_lot 提供快速锁机制
- crossbeam-channel 高效消息传递
- 非阻塞命令处理

### 4. 跨平台兼容
- crossterm 统一终端API
- rodio 跨平台音频支持
- Unicode 完美字符处理

## 📝 许可证

[添加您的许可证信息]

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

## 📧 联系

[添加您的联系信息]

---

**享受您的音乐时光！** 🎵
